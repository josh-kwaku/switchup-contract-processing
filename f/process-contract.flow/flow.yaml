summary: Process Contract
description: >
  Contract processing pipeline. Windmill orchestrates thin HTTP callers
  that delegate all business logic to the Express service
  Steps: ingest → extract (+ validate) → branch (compare or human review).
value:
  modules:
    # Step 1: Ingest — store PDF, parse text, create workflow
    - id: ingest
      summary: Ingest PDF contract
      value:
        type: script
        path: f/process_contract/ingest
        input_transforms:
          pdfBase64:
            type: javascript
            expr: flow_input.pdfBase64
          verticalSlug:
            type: javascript
            expr: flow_input.verticalSlug
          filename:
            type: javascript
            expr: flow_input.filename

    # Step 2: Extract — LLM extraction + validation + contract creation
    # Returns needsReview flag for branching
    - id: extract
      summary: Extract and validate contract data via LLM
      value:
        type: script
        path: f/process_contract/extract
        input_transforms:
          workflowId:
            type: javascript
            expr: results.ingest.workflowId
          pdfText:
            type: javascript
            expr: results.ingest.pdfText
          verticalSlug:
            type: javascript
            expr: flow_input.verticalSlug

    # Step 3: Branch on review requirement
    - id: review_branch
      summary: Route based on review requirement
      value:
        type: branchone
        default:
          # Default path: no review needed → compare tariffs
          - id: compare
            summary: Compare tariffs (mock)
            value:
              type: script
              path: f/process_contract/compare
              input_transforms:
                workflowId:
                  type: javascript
                  expr: results.extract.workflowId
        branches:
          - summary: Needs human review
            expr: results.extract.needsReview === true
            modules:
              # Step A: Suspend flow and present approval form
              - id: approval
                summary: Wait for human review decision
                continue_on_error: true
                value:
                  type: rawscript
                  language: bun
                  content: |
                    import * as wmill from "windmill-client@1";
                    export async function main() {
                      const urls = await wmill.getResumeUrls("reviewer");
                      return { resume: urls.resume, cancel: urls.cancel };
                    }
                suspend:
                  required_events: 1
                  timeout: 86400
                  resume_form:
                    schema:
                      type: object
                      order:
                        - action
                        - correctedData
                        - notes
                      properties:
                        action:
                          type: string
                          description: Review decision
                          enum:
                            - approve
                            - reject
                            - correct
                        correctedData:
                          type: object
                          description: Corrected contract data (only for 'correct' action)
                        notes:
                          type: string
                          description: Optional reviewer notes
                      required:
                        - action

              # Step B: Capture resume data before branching
              - id: capture_resume
                summary: Capture reviewer response
                continue_on_error: true
                value:
                  type: rawscript
                  language: bun
                  content: |
                    export async function main(action: string | null, correctedData: any, notes: string | null) {
                      return { action, correctedData, notes };
                    }
                  input_transforms:
                    action:
                      type: javascript
                      expr: resume.action ?? null
                    correctedData:
                      type: javascript
                      expr: resume.correctedData ?? null
                    notes:
                      type: javascript
                      expr: resume.notes ?? null

              # Step C: Branch — timeout (error) vs reviewer action
              - id: timeout_branch
                summary: Check if approval timed out
                value:
                  type: branchone
                  default:
                    # Normal resume path — reviewer responded
                    - id: handle_review
                      summary: Process review decision
                      value:
                        type: script
                        path: f/process_contract/handle_review
                        input_transforms:
                          workflowId:
                            type: javascript
                            expr: results.extract.workflowId
                          action:
                            type: javascript
                            expr: results.capture_resume.action
                          correctedData:
                            type: javascript
                            expr: results.capture_resume.correctedData ?? null
                          notes:
                            type: javascript
                            expr: results.capture_resume.notes ?? null

                    # Step C: Branch on review outcome
                    - id: review_result_branch
                      summary: Route based on review outcome
                      value:
                        type: branchone
                        default:
                          - id: compare_after_review
                            summary: Compare tariffs after approved review
                            value:
                              type: script
                              path: f/process_contract/compare
                              input_transforms:
                                workflowId:
                                  type: javascript
                                  expr: results.extract.workflowId
                        branches:
                          - summary: Rejected — skip compare
                            expr: results.handle_review.state === 'rejected'
                            modules: []

                  branches:
                    - summary: Timed out — no reviewer response
                      expr: results.capture_resume != null && results.capture_resume.error != null
                      modules:
                        - id: handle_timeout
                          summary: Process review timeout
                          value:
                            type: script
                            path: f/process_contract/handle_timeout
                            input_transforms:
                              workflowId:
                                type: javascript
                                expr: results.extract.workflowId

schema:
  $schema: "https://json-schema.org/draft/2020-12/schema"
  type: object
  properties:
    pdfBase64:
      type: string
      contentEncoding: base64
      description: Base64-encoded PDF contract
    verticalSlug:
      type: string
      description: Vertical identifier
      enum:
        - energy
        - telco
        - insurance
    filename:
      type: string
      description: Optional original filename
  required:
    - pdfBase64
    - verticalSlug
  order:
    - pdfBase64
    - verticalSlug
    - filename
