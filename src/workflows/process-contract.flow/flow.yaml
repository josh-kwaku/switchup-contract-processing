summary: Process Contract
description: >
  End-to-end contract processing pipeline.
  Receives a PDF contract, extracts data via LLM, validates,
  and either completes with tariff comparison or routes to human review.
value:
  modules:
    # Step 1: Trigger — validate input, store PDF, create workflow
    - id: trigger
      summary: Receive and store contract
      value:
        type: script
        path: f/process-contract/triggers/process-contract
        input_transforms:
          pdfBase64:
            type: javascript
            expr: flow_input.pdfBase64
          verticalSlug:
            type: javascript
            expr: flow_input.verticalSlug
          filename:
            type: javascript
            expr: flow_input.filename

    # Step 2: Parse PDF text
    - id: parse_pdf
      summary: Extract text from PDF
      value:
        type: script
        path: f/process-contract/scripts/parse-pdf
        input_transforms:
          pdfBase64:
            type: javascript
            expr: results.trigger.pdfBase64
          workflowId:
            type: javascript
            expr: results.trigger.workflowId

    # Step 3: LLM extraction
    - id: extract_data
      summary: Extract contract data via LLM
      value:
        type: script
        path: f/process-contract/scripts/extract-data
        input_transforms:
          pdfText:
            type: javascript
            expr: results.parse_pdf.pdfText
          workflowId:
            type: javascript
            expr: results.parse_pdf.workflowId
          verticalSlug:
            type: javascript
            expr: results.trigger.verticalSlug

    # Step 4: Validate and score
    - id: validate_data
      summary: Validate extracted data and create contract
      value:
        type: script
        path: f/process-contract/scripts/validate-data
        input_transforms:
          extractionResult:
            type: javascript
            expr: results.extract_data.extractionResult
          workflowId:
            type: javascript
            expr: results.extract_data.workflowId
          verticalId:
            type: javascript
            expr: results.extract_data.verticalId
          requiredFields:
            type: javascript
            expr: results.extract_data.requiredFields

    # Step 5: Branch on review decision
    - id: review_branch
      summary: Route based on review requirement
      value:
        type: branchone
        default:
          # Default: compare tariffs (no review needed)
          - id: compare_tariffs
            summary: Compare tariffs (mock)
            value:
              type: script
              path: f/process-contract/scripts/compare-tariffs
              input_transforms:
                workflowId:
                  type: javascript
                  expr: results.validate_data.workflowId
                contractId:
                  type: javascript
                  expr: results.validate_data.contractId
        branches:
          - summary: Needs human review
            expr: results.validate_data.needsReview === true
            modules: []
            # Empty — review handled by Sprint 5 (suspend/resume)

schema:
  $schema: 'https://json-schema.org/draft/2020-12/schema'
  type: object
  properties:
    pdfBase64:
      type: string
      description: Base64-encoded PDF contract
    verticalSlug:
      type: string
      description: Vertical identifier (energy, telco, insurance)
    filename:
      type: string
      description: Optional original filename
  required:
    - pdfBase64
    - verticalSlug
  order:
    - pdfBase64
    - verticalSlug
    - filename
